<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:ui="http://schemas.microsoft.com/wix/UIExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension"
     xmlns:netfx="http://schemas.microsoft.com/wix/NetFxExtension">

  <?include mySampleVersionInfo.wxi ?>

  <!-- Id="*" to allow reinstalling and automatically removing previous version-->
  <Product Id="*" Name="$(var.PRODUCT_NAME)" Language="1033" Codepage='1252' Version="$(var.PRODUCTVERSION)" Manufacturer="$(var.COMPANY_NAME)" UpgradeCode="$(var.PRODUCTGUID)">

    <Package Comments="$(var.PRODUCT_NAME) $(var.ProcessorArchitecture) $(var.PRODUCTVERSION)" InstallerVersion="200" Compressed="yes" InstallScope="perMachine" Languages='1033' SummaryCodepage='1252' Platform="$(var.ProcessorArchitecture)" />

    <MajorUpgrade DowngradeErrorMessage="A newer version of $(var.PRODUCT_NAME) is already installed." AllowSameVersionUpgrades="yes" />
    <Media Id="1" Cabinet="$(var.PRODUCT_NAME)_$(var.ProcessorArchitecture).cab" EmbedCab="yes" />

    <Feature Id="ProductFeature" Title="$(var.PRODUCT_NAME)" Level="1" Description="mySample $(var.ProcessorArchitecture)" ConfigurableDirectory='INSTALLFOLDER'>
      <ComponentGroupRef Id="_ComponentGpID_MySample" />
    </Feature>

    <Property Id="TARGETDIR" Secure="yes" />
    <Property Id="INSTALLFOLDER" Secure="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <?if $(var.ProcessorArchitecture) = x86 ?>
      <Directory Id="ProgramFilesFolder">
        <Directory Id="ManufacturerFolder" Name="$(var.COMPANY_NAME)">
          <Directory Id="INSTALLFOLDER" Name="$(var.PRODUCT_NAME)">
          </Directory>
        </Directory>
      </Directory>
      <?elseif $(var.ProcessorArchitecture) = x64 ?>
      <Directory Id="ProgramFiles64Folder">
        <Directory Id="ManufacturerFolder" Name="$(var.COMPANY_NAME)">
          <Directory Id="INSTALLFOLDER" Name="$(var.PRODUCT_NAME)">
          </Directory>
        </Directory>
      </Directory>
      <?endif?>
    </Directory>

    <!-- UI information-->
    <Property Id="ARPPRODUCTICON" Value="_FileID_Icon.ico" />
    <Property Id="WIXUI_INSTALLDIR" Value="INSTALLFOLDER" />
    <Property Id="WIXUI_ARPNOMODIFY" Value="yes" Secure="yes" />
    <UIRef Id="WixUI_InstallDir" />
    <UIRef Id="WixUI_ErrorProgressText" />

    <!-- WixUILicenseRtf: License file. -->
    <WixVariable Id="WixUILicenseRtf" Value="Resources\mySample_License.rtf" />
    <!-- WixUIBannerBmp: 493 by 58 pixels, this bitmap will appear at the top of all but the first page of the installer. -->
    <WixVariable Id="WixUIBannerBmp" Value="Resources\companySetupBanner.bmp" />
    <!-- WixUIDialogBmp: 493 by 312 pixels, this bitmap will appear on the first page of the installer. -->
    <WixVariable Id="WixUIDialogBmp" Value="Resources\companySetupDialog.bmp" />
    <Icon Id="_FileID_Icon.ico" SourceFile="Resources\company.ico"/>

    <!--
      WS058503: Note about Secure=yes. If installed with UAC enabled, the uninstall process failed to remove files due to not allowed properties.
      Secure=yes must be used to fixed the issue as describe here: http://www.installsite.org/pages/en/msi/articles/VistaMSI/
    -->

    <!-- Get bitness of installed office version -->
    <Property Id="OFFICE2007BITNESS" Value="x86" Secure="yes"/>
    <!-- No x64 version of 2007 -->
    <Property Id="OFFICE2010BITNESS" Secure="yes">
      <?if $(var.ProcessorArchitecture) = x64 ?>
      <RegistrySearch Id="Office2010Bitness64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Outlook" Name="Bitness" Type="raw" Win64="yes" />
      <?endif?>
      <RegistrySearch Id="Office2010Bitness32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Outlook" Name="Bitness" Type="raw" Win64="no" />
    </Property>
    <Property Id="OFFICE2013BITNESS" Secure="yes">
      <?if $(var.ProcessorArchitecture) = x64 ?>
      <RegistrySearch Id="Office2013Bitness64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Outlook" Name="Bitness" Type="raw"  Win64="yes" />
      <?endif?>
      <RegistrySearch Id="Office2013Bitness32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Outlook" Name="Bitness" Type="raw"  Win64="no" />
    </Property>

    <!-- Get install path of installed office version -->
    <Property Id="EXCEL2007INSTALLPATH" Secure="yes">
      <?if $(var.ProcessorArchitecture) = x64 ?>
      <RegistrySearch Id="OfficeExcel2007InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\12.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <?endif?>
      <RegistrySearch Id="OfficeExcel2007InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\12.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Property Id="EXCEL2010INSTALLPATH" Secure="yes">
      <?if $(var.ProcessorArchitecture) = x64 ?>
      <RegistrySearch Id="OfficeExcel2010InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <?endif?>
      <RegistrySearch Id="OfficeExcel2010InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\14.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>
    <Property Id="EXCEL2013INSTALLPATH" Secure="yes">
      <?if $(var.ProcessorArchitecture) = x64 ?>
      <RegistrySearch Id="OfficeExcel2013InstallPath64" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="yes" />
      <?endif?>
      <RegistrySearch Id="OfficeExcel2013InstallPath32" Root="HKLM" Key="SOFTWARE\Microsoft\Office\15.0\Excel\InstallRoot" Name="Path" Type="raw" Win64="no" />
    </Property>

    <PropertyRef Id="NETFRAMEWORK40FULL" />
    <Condition Message="This setup requires the .NET Framework 4.0 to be installed.">
      <![CDATA[Installed OR NETFRAMEWORK40FULL]]>
    </Condition>
    
    <!-- Detect if at least one office excel has been found -->
    <?if $(var.ProcessorArchitecture) = x86 ?>
    <?define OfficeExcelNotFoundMessage=This setup requires Office Excel 2007, 2010 and/or 2013 (32-bit). ?>
    <?elseif $(var.ProcessorArchitecture) = x64 ?>
    <?define OfficeExcelNotFoundMessage=This setup requires Office Excel 2007, 2010 and/or 2013 (32-bit or 64-bit). ?>
    <?endif?>
    <Condition Message="$(var.OfficeExcelNotFoundMessage)">
      <![CDATA[Installed OR EXCEL2007INSTALLPATH OR EXCEL2010INSTALLPATH OR EXCEL2013INSTALLPATH]]>
    </Condition>
    
    <!-- Custom Actions -->
    <Binary Id="_BinID_CustomAction" SourceFile="$(var.mySampleWiXSetupCA.TargetDir)$(var.CADLLNAME)" />
    <CustomAction Id="Action_RegisterAddIn.SetProperty" Return="check" Property="Action_RegisterAddIn" Value="OFFICEREGKEYS=$(var.OFFICEREGKEYS);XLL32=$(var.XLL32);XLL64=$(var.XLL64)" />
    <CustomAction Id="Action_RegisterAddIn" BinaryKey="_BinID_CustomAction" DllEntry="CaRegisterAddIn" Return="check" Execute="immediate"/>
    <CustomAction Id="Action_UnRegisterAddIn.SetProperty" Return="check" Property="Action_UnRegisterAddIn" Value="OFFICEREGKEYS=$(var.OFFICEREGKEYS);XLL32=$(var.XLL32);XLL64=$(var.XLL64)" />
    <CustomAction Id="Action_UnRegisterAddIn" BinaryKey="_BinID_CustomAction" DllEntry="CaUnRegisterAddIn" Return="check" Execute="immediate" />
    
    <!-- Install Sequence -->
    <InstallExecuteSequence>
      <Custom Action="Action_RegisterAddIn.SetProperty" Before="Action_RegisterAddIn">NOT Installed</Custom>
      <Custom Action="Action_RegisterAddIn" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="Action_UnRegisterAddIn.SetProperty" Before="Action_UnRegisterAddIn">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="Action_UnRegisterAddIn" Before="InstallFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>
    <AdminExecuteSequence>
      <Custom Action="Action_RegisterAddIn.SetProperty" Before="InstallFinalize">NOT Installed</Custom>
      <Custom Action="Action_RegisterAddIn" After="Action_RegisterAddIn.SetProperty">NOT Installed</Custom>
      <Custom Action="Action_UnRegisterAddIn.SetProperty" Before="InstallFinalize">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="Action_UnRegisterAddIn" After="Action_UnRegisterAddIn.SetProperty">Installed AND NOT UPGRADINGPRODUCTCODE</Custom>
    </AdminExecuteSequence>

    <!-- Create our keys in the Registry -->
    <ComponentGroup Id="_ComponentGpID_MySample" >
      <!-- Files to copy in Program Files-->
      <Component Id="_CmpId_ProgramFiles" Directory="INSTALLFOLDER" Guid="$(var.COMPONENTGROUPGUID)">
        <File Id="_FileId_Addin32" Source="$(var.mysample.TargetDir)$(var.XLL32)" />
        <?if $(var.ProcessorArchitecture) = x64 ?>
        <File Id="_FileId_Addin64" Source="$(var.mysample.TargetDir)$(var.XLL64)" />
        <?endif?>

        <RegistryKey Root='HKLM' Key='Software\[Manufacturer]\[ProductName]' >
          <RegistryValue Action='write' Name='InstallPath' Type='string' Value='[INSTALLFOLDER]' />
          <RegistryValue Action='write' Name='ProductVersion' Type='string' Value='[ProductVersion]' />
          <RegistryValue Action='write' Name='ProductName' Type='string' Value='[ProductName]' />
        </RegistryKey>
      </Component>

      <!--Install to version of Office -->

    </ComponentGroup>
  </Product>
</Wix>